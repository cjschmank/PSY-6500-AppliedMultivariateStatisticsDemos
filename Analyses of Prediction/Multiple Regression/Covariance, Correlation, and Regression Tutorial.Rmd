---
title: "Covariance, Correlation, and Regression Tutorial"
author: "Christopher J. Schmank, PhD"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#### **Load Libraries**

```{r echo = TRUE, warning=FALSE, message=FALSE}
library(tidyverse)
library(mice)
library(psych)
library(jmv)
library(apaTables)
```

#### **Variance and Covariance Assessment: Complete Data Examples**

```{r echo=TRUE}
var(attitude)

cov(attitude)

```

- These functions will work interchangeably by default IF AND ONLY IF there is no missing data!

#### **Variance and Covariance Assessment: Incomplete Data Examples**

```{r echo=TRUE}
var(nhanes)

cov(nhanes) # By default this function sets `use = "everything"` 

```

- When missing data is present and default `var()` and `cov()` are used they result in same variance-covariance matrices---unusable in this form!!

```{r}
var(nhanes, na.rm=TRUE) #All cases with NA removed

cov(nhanes, use = "complete.obs") #All cases with NA removed

cov(nhanes, use = "pairwise.complete.obs") #Pairwise deletion --- different N's

```

#### **Calculating Correlation Matrix**

Correlations can be generated with several different functions in base R but get familiar with the `psych` and `JMV` package function calls for correlation matrices

**1. If all you want is a correlation matrix without any additional information**: Use `cor()`

```{r}
cor(attitude)
cor(attitude[1:4]) #Can use subsetting to only pull certain variables into matrix
cor(nhanes) #If missing data is present you must remove it or set `use =` argument
```

**2. If you want to get correlation on ONLY 2 variables at once**: Use `cor.test()`

```{r}
cor.test(~rating + learning, data = attitude)
cor.test(x=attitude$rating, y=attitude$learning)
```

- Provides *t*-test, degrees of freedom, and *p*-value to assess if correlation is statistically significantly different from zero

- Provides correlation coefficient and 95% confidence interval

- Provides type of correlation coefficient calculated (i.e., Pearson's product-moment correlation)

**3. For more detail and details needed for publication**: Use `corr.test()` or `corrMatrix`

```{r}
corr.test(attitude)

corrMatrix(attitude,
           vars = vars(rating, complaints, privileges,learning))
```

**4. If you need to save a correlation matrix for later use**: Use `corr.test()` or `cor()`

```{r}
cor_dat <- psych::corr.test(attitude[1:4])

cor_dat$r # Calls for ONLY the correlation matrix portion of corr.test() output

cor_dat_r <- cor_dat$r # May also want to make an R object for the correlations

```

```{r}
cor_dat2 <- cor(attitude[1:4]) # This code creates a similar object as `cor_dat_r` above
cor_dat2

# Can even use these objects to do rudimentary matrix algebra

cor_dat_r - cor_dat2
```

#### Creating Correlation Table Document

The `apaTables` package can be used to create quick correlation matrices and linear regression tables---these can be helpful but are VERY difficult to reformat or make changes to.

Make sure that you know how to create these tables using other programs like Excel and Word as these allow for much more customization!

```{r}
apa.cor.table(data = attitude[1:4],
              # filename = "attitude-correlation-matrix.doc", # Can uncomment this line to create word doc
              table.number = 1)
```

#### Conducting Bivariate Linear Regression

```{r}
# Easy coding method requires linear model 
# Followed by `anova()` and `summary()` calls for description of model
# Output is less than ideal but coding is efficient
lm <- lm(rating ~ privileges, data = attitude)
anova(lm)
summary(lm)

# JMV coding method requires several argument calls as shown below
# Output is clean but coding gets more difficult with more predictors
linReg(attitude, 
       dep = rating, 
       covs = ("privileges"), 
       blocks = list(
         list("privileges")),
       modelTest = TRUE,
       ci = TRUE,
       stdEst = TRUE,
       ciStdEst = TRUE)

```

#### Creating Regression Table Document

```{r warning=FALSE, message=FALSE}

# Create Word Document with APA style Regression Table

apa.reg.table(lm,
              # filename = "regression_table.doc", # Can uncomment for word doc
              table.number = 2)

set.seed(13)
apa.reg.boot.table(lm,
                   # filename = "regression_boot.doc", # Can uncomment for word doc
                   table.number = 2,
                   number.samples = 5000)
```

